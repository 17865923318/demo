stages:
- name: build
  steps:
  - runScriptConfig:
      image: registry.cn-hangzhou.aliyuncs.com/acs/maven
      shellScript: |-
        cd ./demo
        mvn clean package -Dmaven.test.skip=true
- name: publish
  steps:
  - publishImageConfig:
      dockerfilePath: ./demo/Dockerfile
      buildContext: .
      tag: 17865923318/demo:${CICD_EXECUTION_SEQUENCE}
      pushRemote: true
      registry: index.docker.io
- name: deploy
  steps:
  - runScriptConfig:
      image: gcc:latest
      shellScript: |-
        curl -u "${token-wxmlb}:${zhc47xkgw9tcz7clwjhg7x27ngx7l26wscmfws66pkb298s429b9q4}" \
        -X PUT \
        -H 'Accept: application/json' \
        -H 'Content-Type: application/json' \
        -d '{"annotations":{"cattle.io/timestamp":"2019-12-20T09:24:16Z"}, "containers":[{"allowPrivilegeEscalation":false, "image":"17865923318/demo:50", "imagePullPolicy":"Always", "initContainer":false, "name":"demo", "ports":[{"containerPort":8989, "dnsName":"demo-nodeport", "kind":"NodePort", "name":"8989tcp1", "protocol":"TCP", "sourcePort":0, "type":"/v3/project/schemas/containerPort"}], "privileged":false, "readOnly":false, "resources":{"type":"/v3/project/schemas/resourceRequirements"}, "restartCount":0, "runAsNonRoot":false, "stdin":true, "stdinOnce":false, "terminationMessagePath":"/dev/termination-log", "terminationMessagePolicy":"File", "tty":true, "type":"/v3/project/schemas/container"}], "created":"2019-12-20T09:20:32Z", "creatorId":null, "deploymentConfig":{"maxSurge":1, "maxUnavailable":0, "minReadySeconds":0, "progressDeadlineSeconds":600, "revisionHistoryLimit":10, "strategy":"RollingUpdate"}, "deploymentStatus":{"availableReplicas":1, "conditions":[{"lastTransitionTime":"2019-12-20T09:22:36Z", "lastTransitionTimeTS":1576833756000, "lastUpdateTime":"2019-12-20T09:22:36Z", "lastUpdateTimeTS":1576833756000, "message":"Deployment has minimum availability.", "reason":"MinimumReplicasAvailable", "status":"True", "type":"Available"}, {"lastTransitionTime":"2019-12-20T09:20:32Z", "lastTransitionTimeTS":1576833632000, "lastUpdateTime":"2019-12-20T09:24:00Z", "lastUpdateTimeTS":1576833840000, "message":"ReplicaSet \"demo-66f7dbc78d\" has successfully progressed.", "reason":"NewReplicaSetAvailable", "status":"True", "type":"Progressing"}], "observedGeneration":3, "readyReplicas":1, "replicas":1, "type":"/v3/project/schemas/deploymentStatus", "unavailableReplicas":0, "updatedReplicas":1}, "dnsConfig":null, "dnsPolicy":"ClusterFirst", "ephemeralContainers":[], "gids":[], "hostAliases":[], "hostIPC":false, "hostNetwork":false, "hostPID":false, "imagePullSecrets":[{"name":"dev-dockerhub", "type":"/v3/project/schemas/localObjectReference"}], "labels":{"workload.user.cattle.io/workloadselector":"deployment-default-demo"}, "name":"demo", "namespaceId":"default", "nodeId":"", "ownerReferences":[], "paused":false, "projectId":"c-42x4f:p-cfxq5", "publicEndpoints":[], "readinessGates":[], "restartPolicy":"Always", "scale":1, "scheduling":{"scheduler":"default-scheduler"}, "selector":{"matchLabels":{"workload.user.cattle.io/workloadselector":"deployment-default-demo"}, "type":"/v3/project/schemas/labelSelector"}, "state":"active", "sysctls":[], "terminationGracePeriodSeconds":30, "topologySpreadConstraints":[], "transitioning":"no", "transitioningMessage":"", "uuid":"de682f62-15fd-4933-b109-b4252969a94c", "volumes":[], "windowsOptions":null, "workloadAnnotations":{"deployment.kubernetes.io/revision":"2", "field.cattle.io/creatorId":"user-znxnq"}, "workloadLabels":{"cattle.io/creator":"norman", "workload.user.cattle.io/workloadselector":"deployment-default-demo"}, "workloadMetrics":[]}' \
        'https://106.13.149.36:8091/v3/project/c-42x4f:p-cfxq5/workloads/deployment:default:demo'
timeout: 60
notification: {}
